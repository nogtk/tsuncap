# WORKPLAN: Tsuncap 実装前作業ブレイクダウン（実装前）

本ドキュメントは `spec/overall_specification.md` を唯一の仕様ソースとして、コーディング前にタスクを適切な粒度へ分割するための計画書です。最終的な実装はコーディングエージェントが行います。

## 1. 進め方・原則
- 上から順に依存の少ない基盤 → 多い機能の順で着手。
- 1タスクは半日〜1日規模・独立PR・明確な完了条件を必須化。
- 各タスクは「仕様参照節・完了条件・テスト観点・依存」を記載。
- 実装の判断が割れる場合は `spec/overall_specification.md` を最優先。

## 2. フェーズ別タスク

### フェーズ0: 基盤/プロジェクト
- Xcode雛形（SwiftUI, iOS16+）, ターゲット/Bundle ID 設定。
- 権限文言: `NSCameraUsageDescription` 追加。
- ネットワーク層: `URLSession` ラッパー（タイムアウト/再試行/ロギング）。
- 共通ユーティリティ: 日付整形、スラッグ生成、YAMLレンダリング（テンプレ差し込み）。
- 完了条件: ビルド成功/ユーティリティに最小ユニットテストが通る。

### フェーズ1: 保存先（iCloud/Obsidian Vault）
- `UIDocumentPicker` で `bookLog/memo` 選択。
- セキュリティスコープ付きブックマーク保存/復元、到達性/書込検証。
- 完了条件: 再起動後も指定フォルダにテキストを書ける。

### フェーズ2: ISBNスキャン
- VisionKit DataScanner（可能なら）でEAN-13検出、代替にAVFoundation。
- EAN-13正規化/チェックデジット検証、978/979対応。
- 完了条件: 実機で有効なISBN-13を安定取得、無効EANはUIで再試行提示。

### フェーズ3: 書誌API統合
- Open Libraryクライアント（書誌/著者解決/カバーURL組立）。
- Google Booksクライアント（フォールバック）。
- マージ/優先ロジック（ISBN > タイトル > 著者、カテゴリ1–3件抽出）。
- 完了条件: 代表ISBNでメタデータ/coverURL取得、失敗時はUIに穏当な導線。

### フェーズ4: OCRフォールバック
- 表紙撮影→Vision OCR（JA/EN）→検索語生成（タイトル/著者候補抽出）。
- 曖昧一致検索→候補提示。
- 完了条件: バーコード不達時に1件以上の検索候補を提示。

### フェーズ5: データモデル/テンプレ生成
- `BookMetadata`/`Frontmatter` モデル定義（authors[], categories[], coverUrl 等）。
- 指定テンプレでのYAML生成、`addedDate` 自動挿入。
- 完了条件: テンプレ通りのYAML文字列が生成（スナップショットテスト）。

### フェーズ6: ファイル出力/重複処理
- ファイル名 `{isbn13}-{slug(title)}.md`、UTF-8/LF、末尾余白1行。
- 既存検出→「更新 or 別名（-2, -3…）」分岐、frontmatterマージ実装。
- 完了条件: 両分岐が動作し、更新時はfrontmatter差分が反映。

### フェーズ7: UI（4画面）
- ホーム: キャプチャ起動/最近保存3件/設定導線。
- スキャナ: ライブプレビュー、ISBNヒット表示、OCR導線。
- 確認/編集: タイトル/著者(複数)/カテゴリ(1–3)/ISBN(表示)/coverUrl(編集)/YAMLプレビュー。
- 保存結果: 成功トースト、Obsidianで開く/ファイル表示。
- 完了条件: ハッピーパスがタップ操作で完走。

### フェーズ8: 設定
- 保存先再選択、API優先度、既定ステータス/カテゴリの永続化。
- 完了条件: 設定変更が即時反映＆再起動後も保持。

### フェーズ9: エラーハンドリング/オフライン
- 圏外/API失敗: coverUrl空で保存可。
- 書込不可: フォルダ再選択＋YAMLコピー導線。
- 最小入力（タイトルのみ）保存。
- 完了条件: 仕様「9. エラーハンドリング」の全項目をUIで再現。

### フェーズ10: 連携/仕上げ
- 共有シート「Obsidianで開く」。
- 開発用ログ/クラッシュ最小情報。
- 完了条件: 受け入れ基準（仕様10章）全充足。

## 3. 横断タスク
- 単体テスト（ユーティリティ/モデル/マッパー/テンプレ）。
- UIテスト（ハッピーパス1本、重複処理分岐1本）。
- 実機検証（カメラ/書込）。
- ドキュメント（README: ビルド/設定手順）。

## 4. 依存関係（抜粋）
- フェーズ1 → フェーズ6（出力先確定が前提）。
- フェーズ2/4 → フェーズ3（検索キー入力）。
- フェーズ3/5 → フェーズ6/7（保存/プレビュー）。

## 5. チケット雛形
```
タイトル: [PhaseX] {短い目的}
背景/目的: spec の参照節（例: 2. テンプレ）
実装範囲: 新規/変更ファイル、外部API
受け入れ基準: 動作・UI・エッジケース
テスト観点: ユニット/UI/実機
依存/リスク: 例) フォルダ選択済みが前提
```

## 6. マイルストーン（推奨）
- M1: フェーズ0–1（基盤+書込）
- M2: フェーズ2–3（取得の背骨）
- M3: フェーズ4–6（フォールバック+保存完了）
- M4: フェーズ7–10（UI仕上げ/連携/受け入れ）

