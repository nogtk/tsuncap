# Cross: 実機検証計画

## 1. 目的と参照仕様
- 参照仕様: `spec/overall_specification.md` 第4章・第5章・第9章
- 参照計画: `docs/WORKPLAN.md` 第3章
- 対象フェーズ: Phase2 / Phase4 / Phase6 / Phase9 完了後の実機総合確認
- 目的: カメラ（バーコード・OCR）および iCloud 書き込み機能が仕様通りに動作し、運用で再現可能な手順と検証テンプレートを提供すること

## 2. 前提条件
- テスト端末: iPhone (iOS 16 以上) 実機。最低 1 台、可能なら異なる機種 2 台
- 開発環境: Xcode 15 以上、Apple Developer アカウント（個人でも可）
- ネットワーク: Wi-Fi/LTE 通信環境、および機内モードでの通信遮断手段
- サンプル資料: ISBN-13 バーコード付き書籍 10 冊以上、OCR 用に活字が明瞭な表紙 5 種以上
- iCloud: Obsidian Vault (`bookLog/memo`) が iCloud Drive に存在し、検証端末で同期済みであること

## 3. 検証用ビルド/設定手順
1. Xcode でプロジェクトを開き、ターゲット `Tsuncap` を選択
2. `Signing & Capabilities` で開発チームを設定し、`Camera`・`iCloud Documents` 権限を確認
3. 実機を接続し、`Product > Destination` を端末に設定
4. `Product > Scheme > Edit Scheme...` でビルド構成を `Release (Testing)` に切り替え、ログ出力レベルを INFO 以下に制限（`UserDefaults` or `Environment`）
5. 初回起動時に表示されるフォルダ選択ダイアログで `bookLog/memo` を指定し、書き込み許可を付与
6. 設定画面（ホーム右上）で API 優先度（Open Library → Google Books）、既定ステータス `unread`、既定カテゴリ空を確認
7. `Settings.app > Tsuncap` でカメラ・写真・iCloud の権限が許可済みであることを確認
8. 実機検証ログ取得のため、`Console.app` で対象端末を選択し、`subsystem == "com.example.tsuncap"` などでフィルタして保存

## 4. 検証シナリオ（チェックリスト）

### 4.1 カメラ: バーコードスキャン
- [ ] **S1** 明るい環境で ISBN-13 バーコード 10 冊を連続スキャンし、成功率 9/10 以上（DataScanner が未対応なら AVFoundation 代替を使用）
- [ ] **S2** 暗所（照度 100lx 以下）で 5 冊をテストし、ピント調整後に 3/5 以上で成功
- [ ] **S3** 無効なバーコード（EAN-8 や桁誤り）を読み取らせ、UI が再試行ガイダンスを表示（仕様第4章）
- [ ] **S4** バーコード取得後に API 応答が遅延した場合、ローディング表示が継続し操作がブロックされない
- [ ] **S5** 連続スキャンで同一 ISBN を再検出した際、確認画面の情報が保持される

### 4.2 カメラ: OCR フォールバック
- [ ] **O1** バーコード検出失敗から表紙撮影に遷移できる（導線確認）
- [ ] **O2** OCR 認識結果にタイトルと著者候補が 2 件以上表示され、最終選択が確認画面へ反映
- [ ] **O3** 認識候補が誤っている場合に手動編集が可能（仕様第5章）
- [ ] **O4** オフライン状態（機内モード）でもタイトルのみ保存が可能で、OCR 結果が保持される
- [ ] **O5** OCR セッション終了後にカメラ許可ダイアログが再表示されない

### 4.3 iCloud 書き込み
- [ ] **W1** 初回フォルダ選択後、`bookLog/memo` に Markdown が生成され、ファイル名規則 `{isbn13}-{slug(title)}.md` を満たす
- [ ] **W2** 既存 ISBN を保存し「更新」を選択した場合、frontmatter が差分更新され末尾に空行が維持（仕様第6章）
- [ ] **W3** 「別名保存」を選択した場合に `-2` などの接尾辞が付与されたファイルが生成
- [ ] **W4** オフライン時に保存すると coverUrl 空のまま書き込みが成功し、復帰後も内容が保持（仕様第9章）
- [ ] **W5** フォルダアクセスが期限切れの場合に再認証ダイアログが表示され、再選択後に書き込み再試行で成功

### 4.4 共通確認
- [ ] **C1** 保存後に「Obsidianで開く」「ファイル表示」導線が表示（仕様第5章）
- [ ] **C2** エラー発生時、詳細エラーと「内容をコピー」が表示され、クリップボードに YAML が入る（仕様第9章）
- [ ] **C3** Console ログに致命的なクラッシュや未捕捉例外がないこと

## 5. 実施スケジュール
- Phase2/4/6/9 完了後、統合ブランチで 1 回目の検証を実施
- リリース候補確定前に回帰検証を最低 1 回実施（リグレッション対象は S1/S3/O2/W1/W5）

## 6. 検証記録テンプレート
```
## 検証概要
- 実施日: 2025-__-__
- 実施者: 
- 使用ビルド: (例) Release-Testing 1.0.0 (commit hash)
- 端末: (例) iPhone 14 Pro / iOS 17.4

## 実施結果
| 番号 | 結果 (OK/NG) | 詳細メモ |
|------|--------------|-----------|
| S1   |              |           |
| S2   |              |           |
| S3   |              |           |
| S4   |              |           |
| S5   |              |           |
| O1   |              |           |
| O2   |              |           |
| O3   |              |           |
| O4   |              |           |
| O5   |              |           |
| W1   |              |           |
| W2   |              |           |
| W3   |              |           |
| W4   |              |           |
| W5   |              |           |
| C1   |              |           |
| C2   |              |           |
| C3   |              |           |

## 不具合/改善メモ
- 

## 再発防止策 / フォローアップ
- 
```

